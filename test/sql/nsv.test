# name: test/sql/nsv.test
# description: Test NSV extension — read_nsv and COPY TO
# group: [sql]

require nsv

# ── read_nsv: type narrowing ────────────────────────────────────────

# Create a test file with mixed types using CSV as a writer trick
statement ok
COPY (SELECT * FROM (VALUES ('name'),('age'),('salary'),('active'),(''),('Alice'),('30'),('50000.50'),('true'),(''),('Bob'),('25'),('75000.25'),('false'),(''))) TO '__TEST_DIR__/types.nsv' (FORMAT CSV, HEADER false, QUOTE '');

# Types should be auto-detected
query IIII
SELECT typeof(name), typeof(age), typeof(salary), typeof(active) FROM read_nsv('__TEST_DIR__/types.nsv') LIMIT 1;
----
VARCHAR	BIGINT	DOUBLE	BOOLEAN

# Values should parse correctly
query ITRI
SELECT name, age, salary, active FROM read_nsv('__TEST_DIR__/types.nsv');
----
Alice	30	50000.5	true
Bob	25	75000.25	false

# ── read_nsv: all_varchar ───────────────────────────────────────────

query IIII
SELECT typeof(name), typeof(age), typeof(salary), typeof(active) FROM read_nsv('__TEST_DIR__/types.nsv', all_varchar=true) LIMIT 1;
----
VARCHAR	VARCHAR	VARCHAR	VARCHAR

query TTTT
SELECT name, age, salary, active FROM read_nsv('__TEST_DIR__/types.nsv', all_varchar=true);
----
Alice	30	50000.50	true
Bob	25	75000.25	false

# ── read_nsv: pure strings ──────────────────────────────────────────

statement ok
COPY (SELECT * FROM (VALUES ('city'),('country'),(''),('NYC'),('USA'),(''),('London'),('UK'),(''))) TO '__TEST_DIR__/strings.nsv' (FORMAT CSV, HEADER false, QUOTE '');

query II
SELECT typeof(city), typeof(country) FROM read_nsv('__TEST_DIR__/strings.nsv') LIMIT 1;
----
VARCHAR	VARCHAR

query TT
SELECT * FROM read_nsv('__TEST_DIR__/strings.nsv');
----
NYC	USA
London	UK

# ── read_nsv: aggregations on narrowed types ────────────────────────

query I
SELECT SUM(age) FROM read_nsv('__TEST_DIR__/types.nsv');
----
55

query R
SELECT SUM(salary) FROM read_nsv('__TEST_DIR__/types.nsv');
----
125000.75

# ── read_nsv: boolean filtering ─────────────────────────────────────

query T
SELECT name FROM read_nsv('__TEST_DIR__/types.nsv') WHERE active = true;
----
Alice

# ── COPY TO nsv: roundtrip ──────────────────────────────────────────

# Write a table out as NSV
statement ok
CREATE TABLE roundtrip_src AS SELECT * FROM read_nsv('__TEST_DIR__/types.nsv');

statement ok
COPY roundtrip_src TO '__TEST_DIR__/roundtrip.nsv' (FORMAT nsv);

# Read it back — should match
query ITRI
SELECT name, age, salary, active FROM read_nsv('__TEST_DIR__/roundtrip.nsv');
----
Alice	30	50000.5	true
Bob	25	75000.25	false

# ── COPY TO nsv: types preserved through roundtrip ──────────────────

query IIII
SELECT typeof(name), typeof(age), typeof(salary), typeof(active) FROM read_nsv('__TEST_DIR__/roundtrip.nsv') LIMIT 1;
----
VARCHAR	BIGINT	DOUBLE	BOOLEAN
